<%inherit file="base.mako.html"/>

<%block name="title">
    Litestar HTMX Fullstack With Mako
</%block>

<%block name="header">
    ${parent.header()}
    Author
</%block>


<%block name="intro">
    intro
</%block>
<button onclick="document.getElementById('dialogNew').showModal();">Add New</button>
<dialog id="dialogNew" class="dialog">
    <h4>New Author</h4>
    <form id="dialogNewForm">
        <div>
            <div>
                Name:
                <input type="text" name="name" value="">
            </div>
            <div>
                Date Of Birth:
                <input type="date" name="dob" value="">
            </div>
            <div>
                <button id="closeNew" class="close" onclick="document.getElementById('dialogNew').close();">close</button>
                <button hx-post="new"
                    hx-swap="beforebegin"
                    hx-ext="json-enc"
                    hx-target=".authorListing tr:first-child"
                    hx-on::after-request="closeAndReset()"
                >
                Save
                </button>
            </div>
        </div>
    </form>
    <script>
        function closeAndReset(){
            /* reset the new author form after submission and close the dialog */
            document.querySelector("#dialogNewForm").reset();
            document.getElementById('dialogNew').close();
        }

        /* need to prevent the default action otherwise the URL parameters are screwed up */
        document.getElementById("closeNew").addEventListener("click", function(event){
            event.preventDefault()
        });
    </script>
</dialog>
<table border="1">
    <caption>
        List Of Authors
    </caption>
    <thead>
        <tr>
            <th>
                <!-- mass select/deselect checkboxes -->
                <input type="checkbox" name="masterCheck" _="on click
                    set selectedCount to (<input[name='id']:not(:checked)/>).length
                    set value to (selectedCount == 0)
                    repeat in <input[name='id']/>
                        set it.checked to value
                        it.click()
                    end
                    put selectedCount into the next (<span[id='selectedCount']/>)
                ">
            </th>
            <th></th><th></th><th>Name</th><th>dob</th><th>id</th>
        </tr>
    </thead>
    <tbody class="authorListing" id="authorListing">
        % if len(site_data.items) > 0:
            <h2>Page ${int(currentPage)}</h2>
            % for author in site_data.items:
                <%include file="author.index.row.mako.html" args="author=author"/>
            % endfor
            % if scroll:
                <!-- <tr hx-get="/authors/listing?currentPage=2"
                    hx-trigger="revealed"
                    hx-swap="afterend"
                    hx-push-url="true"
                >
                    <td colspan="6">
                        <h2>Page ${int(currentPage)+1}</h2>
                    </td>
                </tr> -->
            % endif
        % else:
            <tr><td colspan="6">&nbsp;</td></tr>
        % endif
    </tbody>
    <tfoot>
        <tr>
            <td colspan="6">
                <span id="selectedCount">0</span>/<span id="totalRecords">${len(site_data.items)}</span> records
                <span style="float:right">
                    <small><em>${site_data.total} records</em></small>
                </span>
            </td>
        </tr>
    </tfoot>
</table>
<div>
    <h5>Pages</h5>
    % for num in range(1,round(site_data.total/30 + 0.51)+1):
        <a href="listing?currentPage=${num}&scroll=false&pageSize=30">${num}</a>
    % endfor
</div>

<script type="text/hyperscript">
    def countRows()
        -- wait for animations to be complete
        wait 1.1s then
        set selectedCount to (<input[name='id']:checked/>).length
        put selectedCount into (<span[id='selectedCount']/>)

        set totalCount to (<input[name='id']/>).length
        put totalCount into (<span[id='totalRecords']/>)

        if totalCount is selectedCount then
            set x to (<input[name='masterCheck']/>)
            set x.checked to true
    end
</script>
